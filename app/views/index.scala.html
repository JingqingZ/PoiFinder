<!DOCTYPE html>

<html>
    <head>
        <title>PoiFinder</title>
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("semantic/semantic.min.css")">
        <link rel="shortcut icon" type="image/png" href="@routes.Assets.at("images/marker.png")">
        <script src="@routes.Assets.at("javascripts/jquery-1.9.0.min.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("semantic/semantic.min.js")" type="text/javascript"></script>
        <script src="http://maps.googleapis.com/maps/api/js"></script>
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?libraries=drawing"></script>
        <script>
            $( document ).ready(function() {
                setWindowSize()
            });

            $( window ).resize(function() {
                setWindowSize()
            });

            function setWindowSize() {
                $("#googleMap").width($("#googleMapContainer").width());
                $("#googleMapContainer").height($(document).height() * 5 / 6);
                $("#googleMap").height($("#googleMapContainer").height());
                $("#setKWindow").width($(document).width() / 8);
                $("#resultsContainer").height($("#googleMapContainer").height());
            }

            function initialize() {

                var myCenter=new google.maps.LatLng(1.281933, 103.80321);

                var mapProp = {
                    center:myCenter,
                    zoom:12,
                    mapTypeId:google.maps.MapTypeId.ROADMAP
                };

                map=new google.maps.Map(document.getElementById("googleMap"),mapProp);
                markerlist = [];

                var currentShape = null;


                var drawingManager = new google.maps.drawing.DrawingManager({
                    drawingMode: google.maps.drawing.OverlayType.RECTANGLE,
                    drawingControl: true,
                    editable: true,
                    draggable: true,
                    drawingControlOptions: {
                        position: google.maps.ControlPosition.TOP_CENTER,
                        drawingModes: [
                            google.maps.drawing.OverlayType.RECTANGLE
                        ]
                    },
                    rectangleOptions: {
                        fillColor: '#1E90FF',
                        fillOpacity: 0.35,
                        strokeColor: '#1E90FF',
                        strokeWeight: 0,
                        clickable: false,
                        editable: true,
                        zIndex: 1
                    }
                });
                drawingManager.setMap(map);

                google.maps.event.addListener(drawingManager, 'rectanglecomplete', function(rectangle) {
                    var ne = rectangle.getBounds().getNorthEast();
                    var sw = rectangle.getBounds().getSouthWest();
                    //console.log(ne.lat() + ' ' + ne.lng());
                    //console.log(sw.lat() + ' ' + sw.lng());

                    // trigger ajax search

                    //var jqxhr = $.ajax( "/search/1/1/1/1")
                    var jqxhr = $.ajax( "/search/" + ne.lat() + "/" + ne.lng() +
                                               "/" + sw.lat() + "/" + sw.lng())
                        .done(function(results) {
                            //console.log(results);
                            var json = JSON.parse(results);
                            for (i = 0 ; i < markerlist.length ; i++) {
                                markerlist[i].setMap(null);
                            }
                            markerlist = [];
                            for (i = 0 ; i < json["results"].length ; i ++) {
                                var poicenter=new google.maps.LatLng(json["results"][i]["lat"],
                                                                     json["results"][i]["lng"]);
                                var marker = new google.maps.Marker({
                                    position: poicenter,
                                    map: map,
                                    title: json["results"][i]["name"]
                                });
                                markerlist.push(marker);
                                //console.log(json["results"][i]["lat"] + ' ' + json["results"][i]["lng"]);
                            }

                        })
                        .fail(function() {
                            alert( "error" );
                        });

                    if (currentShape) {
                        currentShape.setMap(null);
                    }
                    currentShape = rectangle;
                });

            }

            google.maps.event.addDomListener(window, 'load', initialize);


        </script>
    </head>
    <body>
        <div class="ui secondary pointing menu">
            <a class="item">
                <h3 class="ui header">PoiFinder</h3>
            </a>
            <a class="active item">
                <i class="home icon"></i> Home
            </a>
            <a class="item" id="about-button">
                <i class="info icon"></i> About
            </a>

            <div class="item">
                <div class="ui search">
                    <div class="ui icon input">
                        <input class="prompt" type="text" id="setKWindow" value="5" placeholder="Set k" >
                        <i class="search icon"></i>
                    </div>
                    <div class="results"></div>
                </div>
            </div>

            <a class="right item" href="https://github.com/JingqingZ/PoiFinder" target="_blank" title="前往GitHub" style="margin-top:5px">
                <i class="big github icon"></i>
            </a>

        </div>

        <div class="ui two column grid">
            <div class="four wide column">
                <div class="ui segment" id="resultsContainer">
                    <div id="tagCloud">

                    </div>
                    <table class="ui unstackable table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th class="right aligned">Zoom</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <a class="resultMarker">
                                        Gillman Heights Condominium
                                    </a>
                                    <lat style="display:none">1.281933</lat>
                                    <lng style="display:none">103.80321</lng>
                                </td>
                                <td class="right aligned">
                                    <a class="resultMarker">
                                        <i class="ui icon marker red"></i>
                                    </a>
                                    <lat style="display:none">1.281933</lat>
                                    <lng style="display:none">103.80321</lng>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="twelve wide column">
                <div class="ui segment" id="googleMapContainer">
                    <div id="googleMap" style="width:500px;height:380px;"></div>
                </div>
            </div>
        </div>

        <div class="ui modal" id="about">
            <i class="close icon"></i>
            <div class="header">
               About
            </div>
            <div class="content">
                <div class="image">
                    <img class="ui small image" src="@routes.Assets.at("images/marker.png")">
                </div>
                <div class="description">
                    <h3 class="ui header" style="margin-left:10px">
                        Powered By:
                        <a href="http://semantic-ui.com" target="_blank">Semantic</a> |
                        <a href="https://jquery.com/" target="_blank">jQuery</a> |
                        <a href="https://github.com/lucaong/jQCloud" target="_blank">jQCloud</a> |
                        <a href="https://developers.google.com/maps/documentation/javascript/" target="_blank">Google Map API</a>
                    </h3>
                    <h3 class="ui header" style="margin-left:10px; margin-top:-10px">
                        Thanks To:
                        <a href="#">Prof. Guoliang Li</a> |
                        <a href="#">T.A. Yu Jiang</a>
                    </h3>
                    <h3 class="ui header" style="margin-left:10px; margin-top:-10px">
                         Author:
                        <a href="mailto:zhangjqsmiling@@icloud.com">JingqingZ-THU</a>
                    </h3>
                    <div class="ui divider"></div>
                    <p>
                        This is a demo of the final project of the course Advanced Database Training (THU).
                        In this demo, you can draw a rectangle region and set the value of k,
                        which indicate that you want top k location tags in the region.
                        Results will be shown in the Map and in the left side bar.
                        Great thanks to Prof. Guoliang Li and T.A. Yu Jiang and
                        also thanks to the authors of the APIs and packages I use.
                    </p>
                </div>
            </div>
            <div class="actions">
                <div class="ui button">OK</div>
            </div>
        </div>

    </body>
    <footer>
        <!-- <script src="@routes.Assets.at("javascripts/jquery.tagcloud.js")" type="text/javascript"></script> -->
        <script src="@routes.Assets.at("jqcloud/jqcloud-1.0.4.min.js")" type="text/javascript"></script>
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("jqcloud/jqcloud.css")">
        <script>
            /*
            $.fn.tagcloud.defaults = {
                size: {start: 14, end: 22, unit: 'pt'},
                color: {start: '#cde', end: '#f52'}
            };

            $(function () {
                $('#tagCloud a').tagcloud();
            });
            */

            $("#about-button").click(function() {
                $('#about').modal('show');
            })

            $(".resultMarker").click(function() {
                var lat = $(this).parent().children('lat').text();
                var lng = $(this).parent().children('lng').text();
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(lat, lng)
                });
                window.map.setZoom(16);
                window.map.setCenter(new google.maps.LatLng(lat, lng));
                //marker.setMap(window.map)
            })

             /*!
              * Create an array of word objects, each representing a word in the cloud
              */
             var word_array = [
                 {text: "Lorem", weight: 15},
                 {text: "Ipsum", weight: 9, link: "http://jquery.com/"},
                 {text: "Dolor", weight: 6, html: {title: "I can haz any html attribute"}},
                 {text: "Sit", weight: 7},
                 {text: "Amet", weight: 5}
                 // ...as many words as you want
             ];

             $(function() {
                 // When DOM is ready, select the container element and call the jQCloud method, passing the array of words as the first argument.
                 $("#tagcloud").jQCloud(word_array);
             });
        </script>
    </footer>
</html>
